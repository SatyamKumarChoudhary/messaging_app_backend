import { verifyOTP } from './otpService.js';
import pool from '../../config/db.js';
import jwt from 'jsonwebtoken';

/**
 * Send OTP endpoint
 * POST /api/otp/send
 * Body: { phone: "+919876543210" }
 */
export const sendOTPController = async (req, res) => {
  try {
    const { phone } = req.body;

    // Validate input
    if (!phone) {
      return res.status(400).json({ 
        error: 'Phone number is required' 
      });
    }

    // Validate phone format
    const phoneRegex = /^\+91[6-9]\d{9}$/;
    if (!phoneRegex.test(phone)) {
      return res.status(400).json({ 
        error: 'Invalid phone format. Use: +919876543210' 
      });
    }

    console.log(`üì≤ OTP send request for: ${phone}`);

    // Return success - Frontend will handle actual OTP sending via Firebase Client SDK
    res.json({
      success: true,
      message: 'Ready to send OTP. Use Firebase Client SDK on frontend.',
      phone: phone
    });

  } catch (error) {
    console.error('‚ùå Send OTP controller error:', error);
    res.status(500).json({ 
      error: 'Failed to process OTP request',
      details: error.message 
    });
  }
};

/**
 * Verify OTP endpoint
 * POST /api/otp/verify
 * Body: { idToken: "firebase-id-token-from-frontend" }
 */
export const verifyOTPController = async (req, res) => {
  try {
    const { idToken } = req.body;

    // Validate input
    if (!idToken) {
      return res.status(400).json({ 
        error: 'Firebase ID token is required' 
      });
    }

    console.log('üîê Verifying OTP token...');

    // Verify Firebase token
    const verificationResult = await verifyOTP(idToken);

    if (!verificationResult.success) {
      return res.status(401).json({
        error: verificationResult.message || 'OTP verification failed'
      });
    }

    const { phone, uid: firebase_uid } = verificationResult.user;

    console.log(`‚úÖ OTP verified for: ${phone}`);

    // Check if user exists in database
    const existingUser = await pool.query(
      'SELECT * FROM users WHERE phone = $1',
      [phone]
    );

    let user;
    let isNewUser = false;

    if (existingUser.rows.length > 0) {
      // Existing user - login
      user = existingUser.rows[0];
      console.log(`‚úÖ Existing user login: ${user.id}`);
    } else {
      // New user - need to complete registration
      isNewUser = true;
      console.log(`üÜï New user detected: ${phone}`);
      
      // Return success but indicate registration needed
      return res.status(200).json({
        success: true,
        isNewUser: true,
        phone: phone,
        firebase_uid: firebase_uid,
        message: 'OTP verified. Please complete registration (username, ghost_name, etc.)'
      });
    }

    // Generate JWT token for existing user
    const token = jwt.sign(
      { 
        user_id: user.id, 
        username: user.username,
        phone: user.phone,
        ghost_name: user.ghost_name 
      },
      process.env.JWT_SECRET,
      { expiresIn: '30d' }
    );

    res.json({
      success: true,
      isNewUser: false,
      message: 'Login successful',
      token,
      user: {
        id: user.id,
        username: user.username,
        email: user.email,
        phone: user.phone,
        ghost_name: user.ghost_name,
        bio: user.bio,
        avatar_url: user.avatar_url,
        credits: user.credits,
        is_premium: user.is_premium,
        created_at: user.created_at
      }
    });

  } catch (error) {
    console.error('‚ùå Verify OTP controller error:', error);
    res.status(500).json({ 
      error: 'Failed to verify OTP',
      details: error.message 
    });
  }
};