import admin from './firebaseConfig.js';

/**
 * Send OTP to phone number via Firebase
 * @param {string} phoneNumber - Format: +919876543210
 * @returns {Promise<{success: boolean, message: string, verificationId?: string}>}
 */
export const sendOTP = async (phoneNumber) => {
  try {
    console.log(`üì≤ Sending OTP to: ${phoneNumber}`);

    // Validate phone format (Indian numbers)
    const phoneRegex = /^\+91[6-9]\d{9}$/;
    if (!phoneRegex.test(phoneNumber)) {
      return {
        success: false,
        message: 'Invalid phone format. Use: +919876543210'
      };
    }

    // Note: Firebase Admin SDK doesn't send SMS directly
    // Frontend will handle sending via Firebase Client SDK
    // Backend will verify the OTP token sent by frontend
    
    return {
      success: true,
      message: 'OTP will be sent via frontend Firebase SDK',
      phoneNumber: phoneNumber
    };

  } catch (error) {
    console.error('‚ùå Send OTP error:', error);
    return {
      success: false,
      message: 'Failed to initiate OTP',
      error: error.message
    };
  }
};

/**
 * Verify OTP token from Firebase
 * @param {string} idToken - Firebase ID token from frontend
 * @returns {Promise<{success: boolean, user?: object, message?: string}>}
 */
export const verifyOTP = async (idToken) => {
  try {
    console.log('üîê Verifying Firebase ID token...');

    // Verify the Firebase ID token
    const decodedToken = await admin.auth().verifyIdToken(idToken);
    
    const phoneNumber = decodedToken.phone_number;
    const uid = decodedToken.uid;

    console.log(`‚úÖ Token verified for: ${phoneNumber}`);

    return {
      success: true,
      user: {
        uid: uid,
        phone: phoneNumber,
        firebase_uid: uid
      },
      message: 'OTP verified successfully'
    };

  } catch (error) {
    console.error('‚ùå Verify OTP error:', error);
    return {
      success: false,
      message: 'Invalid or expired OTP',
      error: error.message
    };
  }
};

/**
 * Get or create user by phone number
 * @param {string} phoneNumber - Format: +919876543210
 * @returns {Promise<{success: boolean, user?: object}>}
 */
export const getOrCreateFirebaseUser = async (phoneNumber) => {
  try {
    // Try to get existing user
    let userRecord;
    try {
      userRecord = await admin.auth().getUserByPhoneNumber(phoneNumber);
      console.log(`‚úÖ Found existing Firebase user: ${userRecord.uid}`);
    } catch (error) {
      // User doesn't exist, create new one
      userRecord = await admin.auth().createUser({
        phoneNumber: phoneNumber
      });
      console.log(`‚úÖ Created new Firebase user: ${userRecord.uid}`);
    }

    return {
      success: true,
      user: {
        uid: userRecord.uid,
        phone: userRecord.phoneNumber
      }
    };

  } catch (error) {
    console.error('‚ùå Get/Create user error:', error);
    return {
      success: false,
      error: error.message
    };
  }
};